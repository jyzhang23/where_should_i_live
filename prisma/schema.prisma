// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model City {
  id        String   @id @default(cuid())
  name      String   @unique
  state     String
  regionId  Int?     // Zillow region ID for joining ZHVI data
  latitude  Float?
  longitude Float?

  metrics     CityMetrics?
  zhviHistory ZHVIDataPoint[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CityMetrics {
  id     String @id @default(cuid())
  cityId String @unique
  city   City   @relation(fields: [cityId], references: [id], onDelete: Cascade)

  // === Climate (fallback - primary source is metrics.json -> noaa) ===
  avgTemp        Float? // Average annual temperature (°F)
  avgWinterTemp  Float? // Average winter temperature (°F)
  avgSummerTemp  Float? // Average summer temperature (°F)
  daysOfSunshine Int?   // Days of sunshine per year
  daysOfRain     Int?   // Days of rain per year

  // === Sports/Amenities (Major Professional Leagues) ===
  nflTeams String? // NFL team names (comma-separated)
  nbaTeams String? // NBA team names (comma-separated)
  mlbTeams String? // MLB team names (comma-separated)
  nhlTeams String? // NHL team names (comma-separated)
  mlsTeams String? // MLS team names (comma-separated)

  // === Metadata ===
  dataAsOf  DateTime @default(now())
  updatedAt DateTime @updatedAt

  // NOTE: Demographics, Cost, QoL, Political data now come from metrics.json
  // and are merged in the API layer. See docs/ARCHITECTURE-REVIEW.md
}

model ZHVIDataPoint {
  id     String   @id @default(cuid())
  cityId String
  city   City     @relation(fields: [cityId], references: [id], onDelete: Cascade)
  date   DateTime // Monthly date
  value  Float // Home value in dollars

  @@unique([cityId, date])
  @@index([cityId])
  @@index([date])
}

model DataRefreshLog {
  id             String   @id @default(cuid())
  refreshedAt    DateTime @default(now())
  source         String // "zillow", "census", "manual", etc.
  status         String // "success", "failed"
  recordsUpdated Int?
  errorMessage   String?
}
